name: Generate Intelligence Brief

on:
  schedule:
    - cron: '0 7 * * *'  # Daily at 7:00 AM UTC
  workflow_dispatch:

jobs:
  generate-brief:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        pip install requests python-dateutil
        
    - name: Generate brief
      env:
        GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        python3 << 'PYEND'
        import requests
        import json
        import os
        from datetime import datetime

        def generate_with_grok(prompt):
            api_key = os.environ.get('GROK_API_KEY')
            if not api_key:
                return None, "No Grok API key"
            
            try:
                headers = {
                    'Content-Type': 'application/json',
                    'Authorization': f'Bearer {api_key}'
                }
                
                system_prompt = "You are an elite intelligence analyst with direct access to real-time information from X/Twitter and global news sources. Your mission is to gather, analyze, and synthesize significant intelligence developments. Be methodical and thorough in gathering information. Be skeptical of unverified claims but alert to emerging patterns. Focus on actionable intelligence and strategic implications. Distinguish clearly between confirmed facts, credible reports, and speculation. Think like an intelligence professional: what matters strategically? Leverage your real-time X/Twitter access to monitor breaking developments and official announcements, track statements from government officials, military leaders, and key institutions, identify emerging patterns in geopolitical, technological, and scientific domains, and cross-reference multiple sources for verification. Provide professional intelligence assessments with context, analysis, and strategic implications."
                
                data = {
                    'messages': [
                        {
                            'role': 'system',
                            'content': system_prompt
                        },
                        {
                            'role': 'user',
                            'content': prompt
                        }
                    ],
                    'model': 'grok-4-1-fast-reasoning',
                    'stream': False,
                    'temperature': 0.6,
                    'max_tokens': 4000
                }
                
                response = requests.post(
                    'https://api.x.ai/v1/chat/completions',
                    headers=headers,
                    json=data,
                    timeout=90
                )
                
                if response.status_code == 200:
                    result = response.json()
                    return result['choices'][0]['message']['content'], None
                else:
                    return None, f"Grok error: {response.status_code} - {response.text}"
                    
            except Exception as e:
                return None, f"Grok exception: {str(e)}"

        def generate_with_groq(prompt):
            api_key = os.environ.get('GROQ_API_KEY')
            if not api_key:
                return None, "No Groq API key"
            
            try:
                headers = {
                    'Authorization': f'Bearer {api_key}',
                    'Content-Type': 'application/json'
                }
                
                data = {
                    'model': 'llama-3.3-70b-versatile',
                    'messages': [
                        {
                            'role': 'user',
                            'content': prompt
                        }
                    ],
                    'temperature': 0.6,
                    'max_tokens': 4000
                }
                
                response = requests.post(
                    'https://api.groq.com/openai/v1/chat/completions',
                    headers=headers,
                    json=data,
                    timeout=60
                )
                
                if response.status_code == 200:
                    result = response.json()
                    return result['choices'][0]['message']['content'], None
                else:
                    return None, f"Groq error: {response.status_code}"
                    
            except Exception as e:
                return None, f"Groq exception: {str(e)}"

        def generate_with_gemini(prompt):
            api_key = os.environ.get('GEMINI_API_KEY')
            if not api_key:
                return None, "No Gemini API key"
            
            try:
                url = f'https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key={api_key}'
                
                headers = {'Content-Type': 'application/json'}
                data = {
                    'contents': [{
                        'parts': [{
                            'text': prompt
                        }]
                    }],
                    'generationConfig': {
                        'temperature': 0.6,
                        'maxOutputTokens': 4000,
                    }
                }
                
                response = requests.post(url, headers=headers, json=data, timeout=60)
                
                if response.status_code == 200:
                    result = response.json()
                    return result['candidates'][0]['content']['parts'][0]['text'], None
                else:
                    return None, f"Gemini error: {response.status_code}"
                    
            except Exception as e:
                return None, f"Gemini exception: {str(e)}"

        def generate_brief():
            timestamp = datetime.now().strftime('%Y-%m-%d %H:%M UTC')
            readable_date = datetime.now().strftime('%B %d, %Y at %H:%M UTC')
            
            prompt = f"""INTELLIGENCE BRIEFING REQUEST
Date/Time: {readable_date}

You have real-time access to X/Twitter and global news sources. Conduct a comprehensive intelligence sweep and generate a professional briefing covering significant developments in the past 24 hours.

MISSION OBJECTIVES:

1. GEOPOLITICAL INTELLIGENCE
Scan X/Twitter and news for:
- Active military conflicts and significant tactical developments
- High-level diplomatic engagements and statements
- Political crises, transitions, or major policy announcements
- Economic warfare: sanctions, trade disputes, currency movements
- Strategic alliances and international agreements

Requirements:
- Prioritize developments with strategic implications
- Include specific timestamps, locations, key actors
- Cite official sources (government accounts, verified news outlets)
- Assess potential second-order effects

2. TECHNOLOGY & CYBERSECURITY INTELLIGENCE
Monitor for:
- Major technology breakthroughs or product launches
- Significant cybersecurity incidents (breaches, attacks, vulnerabilities)
- AI policy developments and regulatory actions
- Space program milestones and satellite deployments
- Critical infrastructure developments
- Tech sector strategic moves (acquisitions, partnerships)

Requirements:
- Focus on developments with national security or economic implications
- Include company names, specific technologies, attack vectors
- Note potential dual-use applications

3. UAP/UFO PHENOMENA
Track:
- Official government statements, releases, or hearings
- Military or civilian pilot reports through official channels
- Congressional actions, legislation, or oversight activities
- Scientific research publications or institutional announcements
- Credible sensor data or documentation releases

Requirements:
- Distinguish between official disclosures and speculation
- Focus on verifiable events with documentation
- If no significant developments: state this clearly
- Include dates, locations, official sources

4. PARAPSYCHOLOGY & CONSCIOUSNESS RESEARCH
Survey:
- Peer-reviewed research publications
- Major university or institutional research programs
- Breakthrough experimental results
- Scientific conferences or symposia
- Government or military research disclosures

Requirements:
- Academic and institutional sources only
- Include researcher names, institutions, publication details
- Focus on methodologically sound research
- If no significant developments: acknowledge gap

INTELLIGENCE TRADECRAFT:
- Cross-reference multiple sources for verification
- Distinguish facts from analysis from speculation
- Note information gaps and uncertainties
- Assess credibility of sources
- Provide strategic context and implications
- Use professional intelligence language
- Include specific dates, times, locations, and named sources

OUTPUT FORMAT:
Professional intelligence briefing with clear section headers, concise but comprehensive reporting, bullet points for key developments, strategic assessment where appropriate, and source attribution.

Remember: You are gathering intelligence from real-time sources. Quality over quantity. Strategic relevance over noise."""

            print("Initiating intelligence collection with Grok 4.1 (Reasoning)...")
            content, error = generate_with_grok(prompt)
            
            if content:
                print("Intelligence brief generated successfully with Grok 4.1")
                provider = "Grok 4.1 Fast Reasoning - Real-time Intelligence"
                model_badge = "GROK-4.1-REASONING"
            else:
                print(f"Grok 4.1 failed: {error}")
                print("Falling back to Groq...")
                
                content, error = generate_with_groq(prompt)
                
                if content:
                    print("Generated with Groq fallback")
                    provider = "Groq (llama-3.3-70b-versatile)"
                    model_badge = "GROQ-FALLBACK"
                else:
                    print(f"Groq failed: {error}")
                    print("Final fallback to Gemini...")
                    
                    content, error = generate_with_gemini(prompt)
                    
                    if content:
                        print("Generated with Gemini fallback")
                        provider = "Gemini (gemini-1.5-flash)"
                        model_badge = "GEMINI-FALLBACK"
                    else:
                        raise Exception(f"All providers failed. Last error: {error}")
            
            html_content = """<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Trident Brief - """ + timestamp + """</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: #e0e6ed;
            line-height: 1.7;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1100px;
            margin: 0 auto;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-bottom: 2px solid #3b82f6;
            padding: 40px;
            position: relative;
        }
        .classification {
            display: inline-block;
            background: #dc2626;
            color: white;
            padding: 4px 12px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 1px;
            border-radius: 3px;
            margin-bottom: 15px;
        }
        h1 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2.8em;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: -1px;
            text-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }
        .subtitle {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
            color: #94a3b8;
            margin-bottom: 20px;
            letter-spacing: 2px;
        }
        .meta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85em;
        }
        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #94a3b8;
        }
        .meta-label {
            color: #64748b;
            text-transform: uppercase;
            font-size: 0.75em;
            letter-spacing: 1px;
        }
        .meta-value {
            color: #3b82f6;
            font-weight: 600;
        }
        .model-badge {
            display: inline-block;
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid #3b82f6;
            color: #3b82f6;
            padding: 4px 10px;
            font-size: 0.7em;
            font-weight: 700;
            letter-spacing: 1px;
            border-radius: 4px;
        }
        .content {
            padding: 40px;
        }
        .content pre {
            white-space: pre-wrap;
            font-family: 'Inter', sans-serif;
            font-size: 0.95em;
            line-height: 1.7;
            color: #e0e6ed;
        }
        .footer {
            background: #0f172a;
            border-top: 1px solid rgba(59, 130, 246, 0.3);
            padding: 25px 40px;
            text-align: center;
        }
        .footer-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75em;
            color: #64748b;
            letter-spacing: 1px;
        }
        @media (max-width: 768px) {
            body { padding: 10px; }
            .header { padding: 25px; }
            h1 { font-size: 2em; }
            .content { padding: 25px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="classification">DAILY INTELLIGENCE BRIEF</div>
            <h1>‚öîÔ∏è THE TRIDENT BRIEF</h1>
            <div class="subtitle">AUTOMATED INTELLIGENCE COLLECTION & ANALYSIS</div>
            <div class="meta">
                <div class="meta-item">
                    <span class="meta-label">Generated:</span>
                    <span class="meta-value">""" + timestamp + """</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Source:</span>
                    <span class="model-badge">""" + model_badge + """</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Collection:</span>
                    <span class="meta-value">Real-time X/Twitter + Global News</span>
                </div>
            </div>
        </div>
        <div class="content">
            <pre>""" + content + """</pre>
        </div>
        <div class="footer">
            <div class="footer-text">
                AUTOMATED INTELLIGENCE BRIEFING SYSTEM<br>
                POWERED BY """ + provider + """<br>
                UPDATED DAILY AT 07:00 UTC
            </div>
        </div>
    </div>
</body>
</html>"""
            
            with open('index.html', 'w', encoding='utf-8') as f:
                f.write(html_content)
            
            print(f"Brief successfully published at {timestamp}")

        if __name__ == '__main__':
            try:
                generate_brief()
            except Exception as e:
                print(f"Error generating brief: {e}")
                exit(1)
        PYEND
        
    - name: Commit and push
      run: |
        git config user.name "Trident Intelligence Bot"
        git config user.email "intel@trident.ai"
        git add index.html
        git diff-index --quiet HEAD || git commit -m "üìä Daily Intelligence Brief - $(date -u +'%Y-%m-%d %H:%M UTC')"
        git push
