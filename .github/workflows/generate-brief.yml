name: Generate Intelligence Brief

on:
  schedule:
    - cron: '0 7 * * *'  # Daily at 7:00 AM UTC
  workflow_dispatch:

jobs:
  generate-brief:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        pip install requests python-dateutil
        
    - name: Generate brief
      env:
        GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        python3 << 'PYEND'
        import requests
        import json
        import os
        from datetime import datetime

        def generate_with_grok(prompt):
            api_key = os.environ.get('GROK_API_KEY')
            if not api_key:
                return None, "No Grok API key"
            
            try:
                headers = {
                    'Content-Type': 'application/json',
                    'Authorization': f'Bearer {api_key}'
                }
                
                system_prompt = """You are an elite intelligence analyst with direct access to real-time information from X/Twitter and global news sources. Your mission is to gather, analyze, and synthesize significant intelligence developments.

Your personality and approach:
- Methodical and thorough in gathering information
- Skeptical of unverified claims, but alert to emerging patterns
- Focused on actionable intelligence and strategic implications
- Distinguish clearly between confirmed facts, credible reports, and speculation
- Think like an intelligence professional: what matters strategically?

Leverage your real-time X/Twitter access to:
- Monitor breaking developments and official announcements
- Track statements from government officials, military leaders, and key institutions
- Identify emerging patterns in geopolitical, technological, and scientific domains
- Cross-reference multiple sources for verification

Provide professional intelligence assessments with context, analysis, and strategic implications."""
                
                data = {
                    'messages': [
                        {
                            'role': 'system',
                            'content': system_prompt
                        },
                        {
                            'role': 'user',
                            'content': prompt
                        }
                    ],
                    'model': 'grok-4-1-fast-reasoning',
                    'stream': False,
                    'temperature': 0.6,
                    'max_tokens': 4000
                }
                
                response = requests.post(
                    'https://api.x.ai/v1/chat/completions',
                    headers=headers,
                    json=data,
                    timeout=90
                )
                
                if response.status_code == 200:
                    result = response.json()
                    return result['choices'][0]['message']['content'], None
                else:
                    return None, f"Grok error: {response.status_code} - {response.text}"
                    
            except Exception as e:
                return None, f"Grok exception: {str(e)}"

        def generate_with_groq(prompt):
            api_key = os.environ.get('GROQ_API_KEY')
            if not api_key:
                return None, "No Groq API key"
            
            try:
                headers = {
                    'Authorization': f'Bearer {api_key}',
                    'Content-Type': 'application/json'
                }
                
                data = {
                    'model': 'llama-3.3-70b-versatile',
                    'messages': [
                        {
                            'role': 'user',
                            'content': prompt
                        }
                    ],
                    'temperature': 0.6,
                    'max_tokens': 4000
                }
                
                response = requests.post(
                    'https://api.groq.com/openai/v1/chat/completions',
                    headers=headers,
                    json=data,
                    timeout=60
                )
                
                if response.status_code == 200:
                    result = response.json()
                    return result['choices'][0]['message']['content'], None
                else:
                    return None, f"Groq error: {response.status_code}"
                    
            except Exception as e:
                return None, f"Groq exception: {str(e)}"

        def generate_with_gemini(prompt):
            api_key = os.environ.get('GEMINI_API_KEY')
            if not api_key:
                return None, "No Gemini API key"
            
            try:
                url = f'https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key={api_key}'
                
                headers = {'Content-Type': 'application/json'}
                data = {
                    'contents': [{
                        'parts': [{
                            'text': prompt
                        }]
                    }],
                    'generationConfig': {
                        'temperature': 0.6,
                        'maxOutputTokens': 4000,
                    }
                }
                
                response = requests.post(url, headers=headers, json=data, timeout=60)
                
                if response.status_code == 200:
                    result = response.json()
                    return result['candidates'][0]['content']['parts'][0]['text'], None
                else:
                    return None, f"Gemini error: {response.status_code}"
                    
            except Exception as e:
                return None, f"Gemini exception: {str(e)}"

        def generate_brief():
            timestamp = datetime.now().strftime('%Y-%m-%d %H:%M UTC')
            readable_date = datetime.now().strftime('%B %d, %Y at %H:%M UTC')
            
            prompt = f"""INTELLIGENCE BRIEFING REQUEST
Date/Time: {readable_date}

You have real-time access to X/Twitter and global news sources. Conduct a comprehensive intelligence sweep and generate a professional briefing covering significant developments in the past 24 hours.

MISSION OBJECTIVES:

1. GEOPOLITICAL INTELLIGENCE
Scan X/Twitter and news for:
- Active military conflicts and significant tactical developments
- High-level diplomatic engagements and statements​​​​​​​​​​​​​​​​
