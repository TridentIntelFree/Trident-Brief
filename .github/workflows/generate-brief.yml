name: Generate Intelligence Brief

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  generate-brief:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        pip install requests python-dateutil
        
    - name: Generate brief
      env:
        GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        cat > generate_brief.py << 'EOF'
        import requests
        import json
        import os
        from datetime import datetime

        def generate_with_grok(prompt):
            api_key = os.environ.get('GROK_API_KEY')
            if not api_key:
                return None, "No Grok API key"
            
            try:
                headers = {
                    'Content-Type': 'application/json',
                    'Authorization': f'Bearer {api_key}'
                }
                
                data = {
                    'messages': [
                        {
                            'role': 'system',
                            'content': 'You are a concise intelligence analyst. Provide brief, factual briefings with no elaboration. Be economical with words.'
                        },
                        {
                            'role': 'user',
                            'content': prompt
                        }
                    ],
                    'model': 'grok-2-latest',
                    'stream': False,
                    'temperature': 0.5,
                    'max_tokens': 2000
                }
                
                response = requests.post(
                    'https://api.x.ai/v1/chat/completions',
                    headers=headers,
                    json=data,
                    timeout=60
                )
                
                if response.status_code == 200:
                    result = response.json()
                    return result['choices'][0]['message']['content'], None
                else:
                    return None, f"Grok error: {response.status_code} - {response.text}"
                    
            except Exception as e:
                return None, f"Grok exception: {str(e)}"

        def generate_with_groq(prompt):
            api_key = os.environ.get('GROQ_API_KEY')
            if not api_key:
                return None, "No Groq API key"
            
            try:
                headers = {
                    'Authorization': f'Bearer {api_key}',
                    'Content-Type': 'application/json'
                }
                
                data = {
                    'model': 'llama-3.3-70b-versatile',
                    'messages': [
                        {
                            'role': 'system',
                            'content': 'You are a concise intelligence analyst. Provide brief, factual briefings with no elaboration. Be economical with words.'
                        },
                        {
                            'role': 'user',
                            'content': prompt
                        }
                    ],
                    'temperature': 0.5,
                    'max_tokens': 2000
                }
                
                response = requests.post(
                    'https://api.groq.com/openai/v1/chat/completions',
                    headers=headers,
                    json=data,
                    timeout=60
                )
                
                if response.status_code == 200:
                    result = response.json()
                    return result['choices'][0]['message']['content'], None
                else:
                    return None, f"Groq error: {response.status_code} - {response.text}"
                    
            except Exception as e:
                return None, f"Groq exception: {str(e)}"

        def generate_with_gemini(prompt):
            api_key = os.environ.get('GEMINI_API_KEY')
            if not api_key:
                return None, "No Gemini API key"
            
            try:
                url = f'https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key={api_key}'
                
                headers = {'Content-Type': 'application/json'}
                data = {
                    'contents': [{
                        'parts': [{
                            'text': prompt
                        }]
                    }],
                    'generationConfig': {
                        'temperature': 0.5,
                        'maxOutputTokens': 2000,
                    },
                    'systemInstruction': {
                        'parts': [{
                            'text': 'You are a concise intelligence analyst. Provide brief, factual briefings with no elaboration. Be economical with words.'
                        }]
                    }
                }
                
                response = requests.post(url, headers=headers, json=data, timeout=60)
                
                if response.status_code == 200:
                    result = response.json()
                    return result['candidates'][0]['content']['parts'][0]['text'], None
                else:
                    return None, f"Gemini error: {response.status_code} - {response.text}"
                    
            except Exception as e:
                return None, f"Gemini exception: {str(e)}"

        def generate_brief():
            timestamp = datetime.now().strftime('%Y-%m-%d %H:%M UTC')
            
            prompt = f"""Generate a concise intelligence briefing for {timestamp}.

        BRIEF factual report (500-800 words total):

        1. GEOPOLITICAL INTELLIGENCE
        - 2-3 major developments only
        - Focus on conflicts, diplomacy, sanctions

        2. TECHNOLOGY & CYBERSECURITY  
        - 2-3 significant items only
        - Major breakthroughs, threats, AI policy

        3. UAP/UFO PHENOMENA
        - 1-2 updates if available
        - Official reports, hearings, investigations

        4. PARAPSYCHOLOGY & CONSCIOUSNESS
        - 1-2 notable studies if available
        - Academic research only

        RULES:
        - Concise bullets only, no elaboration
        - ONLY real, verifiable information
        - NO fiction or speculation
        - If no updates: "No significant developments"
        - Max 3-4 bullets per section
        - Include dates/sources when possible

        Format: Section header + brief bullets. Be economical."""

            print("Attempting to generate brief with Grok (real-time data)...")
            content, error = generate_with_grok(prompt)
            
            if content:
                print("Successfully generated with Grok")
                provider = "Grok (grok-2-latest) - Real-time Intelligence"
            else:
                print(f"Grok failed: {error}")
                print("Falling back to Groq...")
                
                content, error = generate_with_groq(prompt)
                
                if content:
                    print("Successfully generated with Groq")
                    provider = "Groq (llama-3.3-70b-versatile)"
                else:
                    print(f"Groq failed: {error}")
                    print("Falling back to Gemini...")
                    
                    content, error = generate_with_gemini(prompt)
                    
                    if content:
                        print("Successfully generated with Gemini")
                        provider = "Gemini (gemini-1.5-flash)"
                    else:
                        raise Exception(f"All providers failed. Last error: {error}")
            
            html = f"""<!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>The Trident Brief - {timestamp}</title>
            <style>
                body {{
                    font-family: 'Courier New', monospace;
                    max-width: 900px;
                    margin: 0 auto;
                    padding: 20px;
                    background: #0a0a0a;
                    color: #00ff00;
                    line-height: 1.6;
                }}
                .header {{
                    text-align: center;
                    border-bottom: 2px solid #00ff00;
                    padding-bottom: 20px;
                    margin-bottom: 30px;
                }}
                .header h1 {{
                    margin: 0;
                    font-size: 2.5em;
                    text-shadow: 0 0 10px #00ff00;
                }}
                .timestamp {{
                    color: #00aa00;
                    font-size: 0.9em;
                    margin-top: 10px;
                }}
                .provider {{
                    color: #00aa00;
                    font-size: 0.8em;
                    font-style: italic;
                }}
                .content {{
                    white-space: pre-wrap;
                    background: #0f0f0f;
                    padding: 20px;
                    border: 1px solid #00ff00;
                    border-radius: 5px;
                }}
                .footer {{
                    text-align: center;
                    margin-top: 30px;
                    padding-top: 20px;
                    border-top: 1px solid #00ff00;
                    color: #00aa00;
                    font-size: 0.8em;
                }}
                .efficiency {{
                    color: #008800;
                    font-size: 0.75em;
                    margin-top: 5px;
                }}
                @media (max-width: 768px) {{
                    body {{
                        padding: 10px;
                    }}
                    .header h1 {{
                        font-size: 1.8em;
                    }}
                }}
            </style>
        </head>
        <body>
            <div class="header">
                <h1>⚔️ THE TRIDENT BRIEF ⚔️</h1>
                <div class="timestamp">Generated: {timestamp}</div>
                <div class="provider">Powered by {provider}</div>
                <div class="efficiency">Token-optimized: ~1000 tokens/brief</div>
            </div>
            <div class="content">{content}</div>
            <div class="footer">
                <p>Automated Intelligence Briefing System</p>
                <p>Triple-redundant AI: Grok → Groq → Gemini</p>
                <p>Updated every 6 hours | Economical token usage</p>
            </div>
        </body>
        </html>"""
            
            with open('index.html', 'w', encoding='utf-8') as f:
                f.write(html)
            
            print(f"Brief generated successfully at {timestamp}")

        if __name__ == '__main__':
            try:
                generate_brief()
            except Exception as e:
                print(f"Error generating brief: {e}")
                exit(1)
        EOF
        
        python generate_brief.py
        
    - name: Commit and push
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        git add index.html
        git diff-index --quiet HEAD || git commit -m "Update intelligence brief - $(date -u +'%Y-%m-%d %H:%M UTC')"
        git push
