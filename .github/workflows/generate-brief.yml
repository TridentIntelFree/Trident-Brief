name: Generate Intelligence Brief

on:
  schedule:
    - cron: '0 7 * * *'  # Daily at 7:00 AM UTC
  workflow_dispatch:

jobs:
  generate-brief:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        pip install requests python-dateutil
        
    - name: Create script
      run: |
        cat > generate.py << 'EOF'
        import requests
        import json
        import os
        from datetime import datetime

        def generate_with_grok(prompt):
            api_key = os.environ.get('GROK_API_KEY')
            if not api_key:
                return None, "No Grok API key"
            
            try:
                headers = {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + api_key
                }
                
                system_prompt = "You are an elite intelligence analyst with direct access to real-time information from X/Twitter and global news sources. Your mission is to gather, analyze, and synthesize significant intelligence developments. Be methodical and thorough in gathering information. Be skeptical of unverified claims but alert to emerging patterns. Focus on actionable intelligence and strategic implications. Distinguish clearly between confirmed facts, credible reports, and speculation. Think like an intelligence professional: what matters strategically? Leverage your real-time X/Twitter access to monitor breaking developments and official announcements, track statements from government officials, military leaders, and key institutions, identify emerging patterns in geopolitical, technological, and scientific domains, and cross-reference multiple sources for verification. Provide professional intelligence assessments with context, analysis, and strategic implications."
                
                data = {
                    'messages': [
                        {
                            'role': 'system',
                            'content': system_prompt
                        },
                        {
                            'role': 'user',
                            'content': prompt
                        }
                    ],
                    'model': 'grok-4-1-fast-reasoning',
                    'stream': False,
                    'temperature': 0.6,
                    'max_tokens': 4000
                }
                
                response = requests.post(
                    'https://api.x.ai/v1/chat/completions',
                    headers=headers,
                    json=data,
                    timeout=90
                )
                
                if response.status_code == 200:
                    result = response.json()
                    return result['choices'][0]['message']['content'], None
                else:
                    return None, "Grok error: " + str(response.status_code)
                    
            except Exception as e:
                return None, "Grok exception: " + str(e)

        def generate_with_groq(prompt):
            api_key = os.environ.get('GROQ_API_KEY')
            if not api_key:
                return None, "No Groq API key"
            
            try:
                headers = {
                    'Authorization': 'Bearer ' + api_key,
                    'Content-Type': 'application/json'
                }
                
                data = {
                    'model': 'llama-3.3-70b-versatile',
                    'messages': [{'role': 'user', 'content': prompt}],
                    'temperature': 0.6,
                    'max_tokens': 4000
                }
                
                response = requests.post(
                    'https://api.groq.com/openai/v1/chat/completions',
                    headers=headers,
                    json=data,
                    timeout=60
                )
                
                if response.status_code == 200:
                    result = response.json()
                    return result['choices'][0]['message']['content'], None
                else:
                    return None, "Groq error"
                    
            except Exception as e:
                return None, str(e)

        def generate_brief():
            timestamp = datetime.now().strftime('%Y-%m-%d %H:%M UTC')
            readable_date = datetime.now().strftime('%B %d, %Y at %H:%M UTC')
            
            prompt = "INTELLIGENCE BRIEFING REQUEST - Date: " + readable_date + "\n\nYou have real-time access to X/Twitter and global news. Generate a professional intelligence briefing on developments in the past 24 hours.\n\n1. GEOPOLITICAL INTELLIGENCE\n- Active conflicts and diplomatic developments\n- Political crises and policy announcements\n- Sanctions and trade disputes\nInclude: timestamps, locations, key actors, official sources\n\n2. TECHNOLOGY & CYBERSECURITY\n- Major breakthroughs and product launches\n- Cybersecurity incidents and vulnerabilities\n- AI policy and space programs\nInclude: companies, technologies, impact assessments\n\n3. UAP/UFO PHENOMENA\n- Official government statements\n- Congressional actions\n- Credible sightings with documentation\nIf no developments, state clearly\n\n4. PARAPSYCHOLOGY & CONSCIOUSNESS RESEARCH\n- Peer-reviewed studies\n- University research programs\n- Breakthrough experiments\nIf no developments, acknowledge gap\n\nUSE INTELLIGENCE TRADECRAFT:\n- Verify with multiple sources\n- Distinguish facts from speculation\n- Note uncertainties\n- Provide strategic context\n- Include dates, times, locations, sources"

            print("Starting Grok 4.1...")
            content, error = generate_with_grok(prompt)
            
            if content:
                provider = "Grok 4.1 Fast Reasoning"
                badge = "GROK-4.1"
            else:
                print("Grok failed, trying Groq...")
                content, error = generate_with_groq(prompt)
                if content:
                    provider = "Groq Llama 3.3"
                    badge = "GROQ"
                else:
                    raise Exception("All failed: " + str(error))
            
            html = """<!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>The Trident Brief</title>
            <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body {
                    font-family: system-ui, -apple-system, sans-serif;
                    background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
                    color: #e0e6ed;
                    padding: 20px;
                    line-height: 1.6;
                }
                .container {
                    max-width: 1100px;
                    margin: 0 auto;
                    background: rgba(15, 23, 42, 0.9);
                    border: 1px solid rgba(59, 130, 246, 0.3);
                    border-radius: 12px;
                    overflow: hidden;
                }
                .header {
                    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
                    border-bottom: 2px solid #3b82f6;
                    padding: 40px;
                }
                .badge {
                    background: #dc2626;
                    color: white;
                    padding: 4px 12px;
                    font-size: 11px;
                    font-weight: 700;
                    border-radius: 3px;
                    display: inline-block;
                    margin-bottom: 15px;
                }
                h1 {
                    font-size: 2.5em;
                    color: #3b82f6;
                    text-transform: uppercase;
                    margin-bottom: 10px;
                }
                .meta {
                    color: #94a3b8;
                    font-size: 0.9em;
                }
                .content {
                    padding: 40px;
                }
                pre {
                    white-space: pre-wrap;
                    font-family: inherit;
                    line-height: 1.7;
                }
                .footer {
                    background: #0f172a;
                    border-top: 1px solid rgba(59, 130, 246, 0.3);
                    padding: 25px;
                    text-align: center;
                    color: #64748b;
                    font-size: 0.85em;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <div class="badge">DAILY INTELLIGENCE BRIEF</div>
                    <h1>‚öîÔ∏è THE TRIDENT BRIEF</h1>
                    <div class="meta">
                        Generated: """ + timestamp + """ | Source: """ + badge + """
                    </div>
                </div>
                <div class="content">
                    <pre>""" + content + """</pre>
                </div>
                <div class="footer">
                    AUTOMATED INTELLIGENCE SYSTEM | """ + provider + """ | DAILY 07:00 UTC
                </div>
            </div>
        </body>
        </html>"""
            
            with open('index.html', 'w') as f:
                f.write(html)
            
            print("Done!")

        if __name__ == '__main__':
            generate_brief()
        EOF
        
    - name: Generate brief
      env:
        GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: python3 generate.py
        
    - name: Commit and push
      run: |
        git config user.name "Trident Bot"
        git config user.email "intel@trident.ai"
        git add index.html
        git diff-index --quiet HEAD || git commit -m "üìä Daily Brief - $(date -u +'%Y-%m-%d')"
        git push
